name: Daily Auto Commit (randomized)

on:
  schedule:
    - cron: '0 * * * *'     # æ¯å°æ—¶ï¼ˆUTCï¼‰æ£€æŸ¥ä¸€æ¬¡
  workflow_dispatch:         # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  auto-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Decide whether to run this hour
        id: decide
        shell: bash
        run: |
          set -euo pipefail

          # ===== é…ç½® =====
          FORCE_WITHIN_HOURS=72   # 3 å¤©æœªæäº¤ => å¼ºåˆ¶æ‰§è¡Œ
          # =================

          DAY_KEY="$(date -u +%Y-%m-%d)"
          CUR_HOUR_UTC=$(date -u +%H)  # 00..23
          REPO="${{ github.repository }}"
          SEED="${DAY_KEY}:${REPO}"
          HSH="$(printf '%s' "$SEED" | sha256sum | cut -d' ' -f1)"

          # --- éš”å¤©è§¦å‘ï¼šæŒ‰è‡ª epoch çš„å¤©æ•°å¥‡å¶ ---
          DAYS_SINCE_EPOCH=$(( $(date -u +%s) / 86400 ))
          ALLOW_TODAY=$(( (DAYS_SINCE_EPOCH % 2) == 0 ? 1 : 0 ))

          # --- æœ€è¿‘ä¸€æ¬¡ update.log çš„æäº¤æ—¶é—´ ---
          LAST_TS=0
          if git ls-files --error-unmatch update.log >/dev/null 2>&1; then
            if git log -1 --format=%ct -- update.log >/dev/null 2>&1; then
              LAST_TS=$(git log -1 --format=%ct -- update.log || echo 0)
            fi
          fi

          NOW_TS=$(date -u +%s)
          HOURS_SINCE=$(( (NOW_TS - LAST_TS) / 3600 ))

          # --- 72 å°æ—¶å¼ºåˆ¶ ---
          FORCE_RUN=0
          if [ "$HOURS_SINCE" -ge "$FORCE_WITHIN_HOURS" ]; then
            FORCE_RUN=1
          fi

          # --- å½“å¤©æœ€å¤šè§¦å‘æ¬¡æ•° N ---
          # å…è®¸æ—¥ï¼šé»˜è®¤ 1 æ¬¡ï¼›50% æ¦‚çŽ‡å‡åˆ° 2 æ¬¡ï¼›éžå…è®¸æ—¥ï¼š0 æ¬¡
          if [ "$ALLOW_TODAY" -eq 1 ]; then
            N=1
            BYTE2=$(( 0x${HSH:2:2} ))
            if [ $(( BYTE2 % 2 )) -eq 0 ]; then
              N=$(( N + 1 ))
            fi
          else
            N=0
          fi

          # --- ä»Žå“ˆå¸Œæ´¾ç”Ÿå‡º N ä¸ªä¸é‡å¤çš„å°æ—¶ ---
          declare -A PICK=()
          i=4
          while [ "${#PICK[@]}" -lt "$N" ]; do
            b=${HSH:$i:2}
            if [ -z "$b" ]; then
              HSH="$(printf '%s+' "$HSH" | sha256sum | cut -d' ' -f1)"
              i=4
              continue
            fi
            h=$(( 0x$b % 24 ))
            PICK[$h]=1
            i=$(( i + 2 ))
          done

          # --- ç»Ÿè®¡ä»Šå¤©å¯¹ update.log çš„æäº¤æ¬¡æ•° ---
          TODAY_BEGIN="$(date -u -d "$(date -u +%Y-%m-%d) 00:00:00" +%s)"
          TODAY_COMMITS=0
          if git ls-files --error-unmatch update.log >/dev/null 2>&1; then
            TODAY_COMMITS=$(git log --since="@${TODAY_BEGIN}" --format='%H' -- update.log | wc -l | tr -d ' ')
          fi

          # --- æœ¬å°æ—¶æ˜¯å¦æ˜¯é€‰ä¸­çš„éšæœºå°æ—¶ ---
          SHOULD_RUN_THIS_HOUR=0
          if [ "$N" -gt 0 ] && [ "${PICK[$((10#$CUR_HOUR_UTC))]+x}" = "x" ]; then
            SHOULD_RUN_THIS_HOUR=1
          fi

          # --- æœ€ç»ˆæ‰§è¡Œåˆ¤å®š ---
          DO_RUN=0
          if [ "$FORCE_RUN" -eq 1 ]; then
            DO_RUN=1
          else
            if [ "$ALLOW_TODAY" -eq 1 ] && [ "$SHOULD_RUN_THIS_HOUR" -eq 1 ] && [ "$TODAY_COMMITS" -lt "$N" ]; then
              DO_RUN=1
            fi
          fi

          echo "ALLOW_TODAY=$ALLOW_TODAY, N=$N, CUR_HOUR=$CUR_HOUR_UTC"
          echo "Random picks (UTC hours): ${!PICK[*]}"
          echo "TODAY_COMMITS=$TODAY_COMMITS, FORCE_RUN=$FORCE_RUN, HOURS_SINCE_LAST=$HOURS_SINCE"
          echo "do_run=$DO_RUN" >> "$GITHUB_OUTPUT"

      - name: Stop if not selected to run
        if: steps.decide.outputs.do_run == '0'
        run: |
          echo "â­ï¸ Skip: not selected (and within 72h)."
          exit 0

      - name: Set git identity
        run: |
          git config --global user.name "wenxiy"
          git config --global user.email "193367189@qq.com"

      - name: Write update log
        run: |
          echo "Updated on $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> update.log

      - name: Commit and push
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          git add update.log
          git commit -m "ðŸ•’ Randomized update on $(date -u '+%Y-%m-%d %H:%M:%S') UTC" || { echo "Nothing to commit"; exit 0; }
          BRANCH="$(git rev-parse --abbrev-ref HEAD)"
          if [ "$BRANCH" = "HEAD" ]; then
            if git show-ref --verify --quiet refs/heads/main; then BRANCH=main;
            elif git show-ref --verify --quiet refs/heads/master; then BRANCH=master;
            else BRANCH="$(git branch --show-current)"; fi
          fi
          git push "https://x-access-token:${TOKEN}@github.com/${{ github.repository }}.git" "HEAD:${BRANCH}"
