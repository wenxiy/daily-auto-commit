name: Daily Auto Commit (randomized)

on:
  schedule:
    - cron: '0 * * * *'      # æ¯å°æ—¶è§¦å‘ä¸€æ¬¡ï¼ˆUTCï¼‰
  workflow_dispatch:          # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  auto-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # éœ€è¦è¯»å– update.log çš„åŽ†å²ä»¥è®¡ç®—â€œ3 å¤©å†…å¿…è§¦å‘â€

      - name: Decide whether to run this hour
        id: decide
        shell: bash
        run: |
          set -euo pipefail

          # -------- é…ç½®ï¼šéšæœºèŒƒå›´ä¸Žå¼ºåˆ¶é˜ˆå€¼ --------
          MIN_PER_DAY=0
          MAX_PER_DAY=5               # æ¯å¤©éšæœº 0..5 æ¬¡
          FORCE_WITHIN_HOURS=$((72))  # ä¸‰å¤© = 72 å°æ—¶ï¼Œè¶…æ—¶å¼ºåˆ¶æ‰§è¡Œ

          # -------- è®¡ç®—ä»Šå¤©çš„éšæœºæ¬¡æ•° Nï¼ˆ0..5ï¼ŒæŒ‰æ—¥æœŸ+ä»“åº“ç¡®å®šæ€§éšæœºï¼‰--------
          DAY_KEY="$(date -u +%Y-%m-%d)"
          SEED="$(printf '%s:%s' "$DAY_KEY" "${{ github.repository }}")"
          HSH="$(printf '%s' "$SEED" | sha256sum | cut -d' ' -f1)"
          N=$(( 0x${HSH:0:2} % (MAX_PER_DAY - MIN_PER_DAY + 1) + MIN_PER_DAY ))

          # -------- ä»Žå“ˆå¸Œä¸­æ´¾ç”Ÿå‡º N ä¸ªä¸é‡å¤çš„å°æ—¶ï¼ˆ0..23ï¼‰--------
          declare -A PICK=()
          i=2
          while [ "${#PICK[@]}" -lt "$N" ]; do
            b=${HSH:$i:2}
            # è‹¥å“ˆå¸Œç”¨å°½ï¼Œé‡æ–°å“ˆå¸ŒåŠ ç›
            if [ -z "$b" ]; then
              HSH="$(printf '%s+' "$HSH" | sha256sum | cut -d' ' -f1)"
              i=2
              continue
            fi
            h=$(( 0x$b % 24 ))
            PICK[$h]=1
            i=$(( i + 2 ))
          done

          CUR_HOUR_UTC=$(date -u +%H)     # 00..23
          SHOULD_RUN_THIS_HOUR=0
          if [ "$N" -gt 0 ] && [ "${PICK[$((10#$CUR_HOUR_UTC))]+x}" = "x" ]; then
            SHOULD_RUN_THIS_HOUR=1
          fi

          # -------- è¯»å– update.log æœ€è¿‘ä¸€æ¬¡æäº¤æ—¶é—´ï¼ˆç§’ï¼‰--------
          LAST_TS=0
          if git ls-files --error-unmatch update.log >/dev/null 2>&1; then
            if git log -1 --format=%ct -- update.log >/dev/null 2>&1; then
              LAST_TS=$(git log -1 --format=%ct -- update.log || echo 0)
            fi
          else
            # æ–‡ä»¶ä¸å­˜åœ¨ï¼Œé¦–æ¬¡è¿è¡Œæ—¶å¼ºåˆ¶æ‰§è¡Œä¸€æ¬¡ä»¥åˆ›å»º
            LAST_TS=0
          fi

          NOW_TS=$(date -u +%s)
          HOURS_SINCE=$(( (NOW_TS - LAST_TS) / 3600 ))

          FORCE_RUN=0
          if [ "$HOURS_SINCE" -ge "$FORCE_WITHIN_HOURS" ]; then
            FORCE_RUN=1
          fi

          DO_RUN=$(( SHOULD_RUN_THIS_HOUR || FORCE_RUN ))
          echo "Random picks today (UTC hours): ${!PICK[*]}"
          echo "N=$N, CUR_HOUR=$CUR_HOUR_UTC, SHOULD_RUN=$SHOULD_RUN_THIS_HOUR, FORCE_RUN=$FORCE_RUN, HOURS_SINCE_LAST=$HOURS_SINCE"
          echo "do_run=$DO_RUN" >> "$GITHUB_OUTPUT"

      - name: Stop if not selected to run
        if: steps.decide.outputs.do_run == '0'
        run: |
          echo "â­ï¸ Skipping this hour (not in today's random picks and within 72h)."
          exit 0

      - name: Set git identity
        run: |
          git config --global user.name "wenxiy"
          git config --global user.email "193367189@qq.com"

      - name: Write update log
        run: |
          echo "Updated on $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> update.log

      - name: Commit and push
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          git add update.log
          git commit -m "ðŸ•’ Randomized update on $(date -u '+%Y-%m-%d %H:%M:%S') UTC" || { echo "Nothing to commit"; exit 0; }

          BRANCH="$(git rev-parse --abbrev-ref HEAD)"
          # å…¼å®¹éƒ¨åˆ†åœºæ™¯ä¸‹ HEAD ä¸º 'HEAD'ï¼ˆdetachedï¼‰ï¼Œåˆ™å›žé€€åˆ°é»˜è®¤åˆ†æ”¯ main/master ä¹‹ä¸€
          if [ "$BRANCH" = "HEAD" ]; then
            if git show-ref --verify --quiet refs/heads/main; then BRANCH=main;
            elif git show-ref --verify --quiet refs/heads/master; then BRANCH=master;
            else BRANCH="$(git branch --show-current)"; fi
          fi

          git push "https://x-access-token:${TOKEN}@github.com/${{ github.repository }}.git" "HEAD:${BRANCH}"
